<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="author" content="Moazzam Ahmed">
	<title>Function Calls from EVM based smart contract</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.5/web3.min.js"
		integrity="sha512-/T7YwzOsNeoNkuTfYKXn3CrJCGc5cnC8T4QW46Hy+3Xjdjrxzokmbx8M8Xavjq1K7dN4958kIRGy4J03VRIlSg=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
	<div>
		<h1>Function Calls from EVM based smart contract</h1>
		<h4 id="metamask_msg">Required metamask for transactions</h4>
		<button id="connectwallet" style="margin-bottom: 20px;">Connect Metamask</button>
		<fieldset>
			<legend>Web3 & Contract Details</legend>
			<form id="web3details" method="post">
				<label for="web3rpc">Network RPC</label>
				<input type="text" name="web3rpc" id="web3rpc">
				<label for="contractaddress">Contract Address</label>
				<input type="text" name="contractaddress" id="contractaddress">
				<br>
				<br>
				<label for="contractaddress">Contract ABI</label>
				<textarea name="abi" id="abi" rows="20" cols="50"></textarea>
				<br>
				<br>
				<button type="submit">Update</button>
			</form>
		</fieldset>
		<br>
		<fieldset id="container">
			<legend>Functions Calls</legend>
			<p>Type</p>
			<ul>
				<li>nonpayable -> Send Function without passing native token or msg.value</li>
				<li>payable -> Send Function with native token or msg.value</li>
				<li>view -> Call Function</li>
			</ul>
		</fieldset>
	</div>


	<script>
		let contract;
		let address;
		let web3;

		const connectwalletBtn = document.getElementById("connectwallet");
		const metamask_msg = document.getElementById("metamask_msg");

		const connect = async () => {
			if (window.ethereum) {
				web3 = new Web3(window.ethereum);
				try {
					// Request account access if needed
					const accounts = await window.ethereum.request({
						"method": "eth_requestAccounts",
						"params": []
					});
					address = accounts[0];
					console.log(address)

					window.ethereum.on("accountsChanged", async (accounts) => {
						address = accounts[0];
						console.log(address)
						metamask_msg.innerHTML = address ? `Metamask Connected (${address})` : "Required metamask for transactions. Metamask Not Connected";
						connectwalletBtn.style.display = address ? "none" : "block";
					});

					metamask_msg.innerHTML = `Required metamask for transactions. Metamask Connected (${address})`;
					connectwalletBtn.style.display = "none";
				} catch (error) {
					metamask_msg.innerHTML = "Required metamask for transactions. Metamask Not Connected";
					connectwalletBtn.style.display = "block";
					console.log(error)
				}
			} else {
				console.log(
					'Non-Ethereum browser detected. You should consider trying MetaMask!'
				);
			}
		}

		window.addEventListener('load', async () => {

			const abi = JSON.parse(window.localStorage.getItem('abi'));
			const contractaddress = window.localStorage.getItem('contractaddress');
			const rpc = window.localStorage.getItem('rpc');
			if (rpc) {
				web3 = new Web3(rpc);
			}

			document.getElementById("web3rpc").value = rpc;
			document.getElementById("contractaddress").value = contractaddress;
			document.getElementById("abi").value = JSON.stringify(abi, null, 2);

			await connect();

			if (!abi || !contractaddress || !web3) {
				return;
			}

			contract = new web3.eth.Contract(abi, contractaddress);

			const groups = abi.filter(element => element.type === 'function')
				.map(element => {
					const button = document.createElement('button');
					button.textContent = `(${element.stateMutability}) ${element.name}`;
					button.onclick = (e) => handleClick(e, element.stateMutability === 'view');

					const group = document.createElement('div');
					group.setAttribute("class", "group");

					const brEle = document.createElement('br');
					const brEle2 = document.createElement('br');
					group.appendChild(brEle);
					group.appendChild(button);

					for (let i = 0; i < element.inputs.length; i++) {
						const input = element.inputs[i];
						const inputText = document.createElement('input');
						inputText.setAttribute("type", "text");
						inputText.setAttribute("placeholder", `${input.type} ${input.name}`);
						group.appendChild(inputText);
					}

					const display = document.createElement('span');

					group.appendChild(brEle2);
					group.appendChild(display);
					return group;

				});

			const container = document.getElementById("container");

			for (let i = 0; i < groups.length; i++) {
				container.appendChild(groups[i]);
			}
		});

		async function handleClick(event, isCallFnc) {
			const button = event.target;
			console.log(button)

			const children = [...button.parentNode.children];
			const inputs = children.filter(element => element.nodeName === 'INPUT');

			const args = inputs.map(input => input.value);

			const buttonText = button.innerText;
			const functionName = buttonText.slice(buttonText.indexOf(")") + 1, buttonText.length).trim();
			console.log("functionName: ", functionName);

			const contractMethod = contract.methods[functionName](...args);
			const result = await contractMethod[isCallFnc ? "call" : "send"]({ from: address });

			console.log("result: ", result)

			const displaySpan = children[children.length - 1];

			displaySpan.innerText = JSON.stringify(result);
		}

		const web3form = document.getElementById("web3details");
		web3form.addEventListener("submit", async (event) => {
			event.preventDefault();
			const formData = new FormData(web3form);
			const rpc = formData.get("web3rpc");
			const contractaddress = formData.get("contractaddress");
			const abi = formData.get("abi");

			window.localStorage.setItem('rpc', rpc);
			window.localStorage.setItem('contractaddress', contractaddress);
			window.localStorage.setItem('abi', abi);

			window.location.reload();
		});

		connectwalletBtn.addEventListener("click", async (event) => {
			event.preventDefault();
			await connect();
		});

	</script>

</body>
</html>
